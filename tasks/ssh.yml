---

- name: Manage ssh
  block:
    - lineinfile:
        state: absent
        path: "/etc/ssh/sshd_config"
        regexp: "{{ item }}"
      with_items:
        - "^#.*"
        - "^\\s*$"
        - "UsePAM.*"
    - lineinfile:
        state: present
        path: "/etc/ssh/sshd_config"
        line: "{{ item.line }}"
        regexp: "^{{ item.regexp }}.*"
      with_items:
        - {'line': 'Port {{ ssh_port | default(22) }}', 'regexp': 'Port'}
        - {'line': 'PubkeyAuthentication yes', 'regexp': 'PubkeyAuthentication'}
        - {'line': 'ListenAddress 0.0.0.0', 'regexp': 'ListenAddress'}
        - {'line': 'SyslogFacility AUTH', 'regexp': 'SyslogFacility'}
        - {'line': 'LogLevel DEBUG', 'regexp': 'LogLevel'}
        - {'line': 'LoginGraceTime 10s', 'regexp': 'LoginGraceTime'}
        - {'line': 'PermitRootLogin without-password', 'regexp': 'PermitRootLogin'}
        - {'line': 'MaxAuthTries 2', 'regexp': 'MaxAuthTries'}
        - {'line': 'PasswordAuthentication yes', 'regexp': 'PasswordAuthentication'}
        - {'line': 'PermitEmptyPasswords no', 'regexp': 'PermitEmptyPasswords'}
        - {'line': 'ChallengeResponseAuthentication yes', 'regexp': 'ChallengeResponseAuthentication'}
        - {'line': 'GatewayPorts yes', 'regexp': 'GatewayPorts'}
        - {'line': 'AllowAgentForwarding yes', 'regexp': 'AllowAgentForwarding'}
        - {'line': 'PubkeyAuthentication yes', 'regexp': 'PubkeyAuthentication'}
        - {'line': 'UseDNS no', 'regexp': 'UseDNS'}
        - {'line': 'AuthorizedKeysFile .ssh/authorized_keys', 'regexp': 'AuthorizedKeysFile'}
        - {'line': 'PrintMotd no', 'regexp': 'PrintMotd'}
      register: sshd_config
    - name: Allow ssh port
      register: iptables_sshd
      iptables:
        chain: INPUT
        ctstate: NEW,ESTABLISHED
        source: 0.0.0.0/0
        protocol: tcp
        jump: ACCEPT
        destination_port: "{{ ssh_port | default(49384) }}"
      when: ssh_iptables | default(False)
    - name: Restart sshd
      when: sshd_config.changed
      service:
        name: sshd
        state: restarted

